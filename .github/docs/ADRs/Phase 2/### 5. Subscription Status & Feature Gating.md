## ADR: Subscription Status & Feature Gating

- **Status:** Accepted
- **Date:** 2025-10-26
- **Owners:** Billing/Monitors squad

### Context

Phase 2 requires that tenants upgrade from the Free plan through Stripe Checkout and see the new plan reflected everywhere. The backend already persisted `subscription_status` on the `Client` model, but the webhook endpoint was not consuming the secret, and the frontend billing page still presented the Free plan as active even after a successful checkout. We also needed structured logging for auditability.

### Decision

1. Load `STRIPE_WEBHOOK_SECRET` in `app/settings.py` so `StripeWebhookView` can verify signatures. Emit structured events with event/session identifiers to both `payments.webhooks` and a new `payments.subscriptions` logger.
2. Update `StripeWebhookView` to translate `checkout.session.completed` and `invoice.paid` into `SubscriptionStatus.PRO`, and `customer.subscription.deleted` into `SubscriptionStatus.CANCELED`, persisting changes on the tenant.
3. Keep endpoint creation limited on the Free tier and rely on existing tests in `monitors/tests/test_endpoints_api.py` plus expanded webhook tests (`backend/tests/test_billing_webhooks.py`) to guarantee plan enforcement.
4. Hydrate the frontend subscription store from `/api/auth/me/`, use it across the dashboard header, gating logic, and the billing page, and log page-level telemetry to disk during local development.

### Consequences

- Manual webhook replays now succeed (200) and write entries like `event_id`, `session_id`, and status transitions to `logs/webhooks.log` and `logs/subscriptions.log`, providing end-to-end traceability.
- `/dashboard` and `/billing` display the correct plan badge/CTA as soon as the webhook processes; the billing CTA disables once a tenant is on Pro, preventing redundant checkouts.
- The existing Free-tier limit still returns HTTP 403 once three endpoints exist, and logs a gating event to `frontend/src/logs/subscription-events.log` for QA.
- Future work, such as Stripe customer portal integration, can reuse the subscription logger plumbing to audit plan changes without additional instrumentation.
