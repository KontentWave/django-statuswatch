# Stripe Subscription Checkout — Implementation Detail

## Overview

Free-plan tenants can now upgrade to the Pro subscription using Stripe Checkout. The frontend surfaces plans on `/billing`, opens a Stripe-hosted session, and records checkout phases, while the backend issues subscription-mode sessions and logs outcomes for auditing.

## Frontend Implementation

- **Routing:** `frontend/src/app/router.tsx` registers `/billing`, `/billing/success`, and `/billing/cancel` inside the authenticated route tree to ensure only logged-in users access the upgrade flow.
- **Billing Page:** `frontend/src/pages/Billing.tsx` uses TanStack Query to call `createBillingCheckoutSession("pro")`, remembers the selected plan via `billing-storage`, and emits `initiated`/`redirected` events with `billing-logger` before redirecting to Stripe.
- **Success & Cancel Pages:** `frontend/src/pages/BillingSuccess.tsx` and `frontend/src/pages/BillingCancel.tsx` read the stored plan, inspect the `session_id` query parameter, log the `completed` or `canceled` phase, and provide navigation back to `/dashboard` or `/billing`.
- **Utilities:**
  - `frontend/src/lib/billing-client.ts` wraps the `/api/billing/create-checkout-session/` POST request and normalises error responses.
  - `frontend/src/lib/billing-logger.ts` standardises log payloads for the billing flow.
  - `frontend/src/lib/billing-storage.ts` stores the plan choice in `sessionStorage`, exposing helpers to remember and consume the value around redirects.

## Backend Implementation

- **Stripe Session Endpoint:** `BillingCheckoutSessionView` in `backend/payments/views.py` enforces Stripe key configuration, maps plans to `STRIPE_PRO_PRICE_ID`, and calls `stripe.checkout.Session.create` in subscription mode with tenant schema metadata and the user’s email.
- **Routing:** `payments/billing_urls.py` exposes `create-checkout-session/`; both `backend/app/urls_tenant.py` and `backend/app/urls_public.py` include it under `/api/billing/` to keep tenant and public schemas aligned.
- **Settings:** `backend/app/settings.py` now reads `FRONTEND_URL` (default `http://localhost:5173`) to build success and cancel return URLs. Local `.env` pins `FRONTEND_URL=https://localhost:5173` to match the HTTPS Vite dev server.
- **Logging:** The view writes structured entries to the `payments.billing` and `payments.checkout` logger namespaces, which feed dedicated log files (`backend/logs/billing.log`, `backend/logs/payments.log`). Errors sanitise messages to avoid leaking Stripe payloads.

## Testing

- **Frontend:**
  - `frontend/src/pages/__tests__/BillingPage.test.tsx` asserts the upgrade button calls the client, logs phases, and navigates to the returned Stripe URL.
  - `frontend/src/pages/__tests__/BillingSuccessPage.test.tsx` verifies session ID rendering, logging of the `completed` event, and navigation handlers.
  - `frontend/src/pages/__tests__/BillingCancelPage.test.tsx` covers the cancel narrative, logging, and retry CTA behaviour.
- **Manual Smoke Test:** Confirmed end-to-end checkout with Stripe test card `4242 4242 4242 4242`, validating redirect back to `/billing/success`, presence of the session ID, and log output for both billing and checkout loggers.

## Operational Notes

- Stripe errors such as missing or invalid price IDs surface as `ConfigurationError`/`PaymentProcessingError` responses and are logged with sanitized metadata for debugging.
- Checkout metadata includes `tenant_schema`, `user_id`, and `plan`, priming future webhook handlers to locate and update tenant subscriptions.
- Follow-up work will introduce Stripe webhook handling to persist subscription state, expose active plan status on `/billing`, and add downgrade/cancel options once server-side state is authoritative.
