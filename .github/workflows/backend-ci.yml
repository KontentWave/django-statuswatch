name: Backend CI

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  backend:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: devpass
          POSTGRES_DB: dj01
        ports:
          - "5432:5432"
        options: >-
          --health-cmd="pg_isready -U postgres -d dj01"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
      redis:
        image: redis:7
        ports:
          - "6379:6379"
        options: >-
          --health-cmd="redis-cli ping || exit 1"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    env:
      SECRET_KEY: django-insecure-ci-testing-key-not-for-production
      DEBUG: "1"
      DATABASE_URL: postgresql://postgres:devpass@localhost:5432/dj01
      REDIS_URL: redis://localhost:6379/0
      STRIPE_PUBLIC_KEY: pk_test_dummy
      STRIPE_SECRET_KEY: sk_test_dummy
      DJANGO_SETTINGS_MODULE: app.settings
      PYTHONUNBUFFERED: "1"

    defaults:
      run:
        working-directory: backend

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip
          cache-dependency-path: backend/requirements*.txt

      - name: Install deps
        run: |
          python -m pip install -U pip
          pip install -r requirements-dev.txt

      - name: Run tests in batches to avoid resource exhaustion
        timeout-minutes: 30
        run: |
          set -e
          echo "Running tests in batches to prevent PostgreSQL connection exhaustion..."

          # Batch 1: Fast unit tests
          echo "Batch 1: Unit tests (admin, auth, utils, settings)"
          python -m pytest tests/test_admin_url.py tests/test_auth_service.py tests/test_ci_smoke.py tests/test_db_user.py tests/test_django_checks.py tests/test_imports.py tests/test_settings.py -v --tb=short

          # Batch 2: Billing tests (with skipped throttle tests)
          echo "Batch 2: Billing tests"
          python -m pytest tests/test_billing_*.py -v --tb=short

          # Batch 3: JWT and token tests
          echo "Batch 3: JWT and authentication"
          python -m pytest tests/test_jwt_rotation.py tests/test_token_refresh.py tests/test_login.py tests/test_current_user.py tests/test_multi_tenant_auth.py -v --tb=short

          # Batch 4: Security and validation
          echo "Batch 4: Security tests"
          python -m pytest tests/test_password_complexity.py tests/test_security_headers.py tests/test_https_enforcement.py tests/test_rate_limiting.py -v --tb=short

          # Batch 5: Email and registration
          echo "Batch 5: Email and registration"
          python -m pytest tests/test_email_verification.py tests/test_registration.py tests/test_duplicate_org_name_pytest.py -v --tb=short

          # Batch 6: API endpoints and health
          echo "Batch 6: API and health checks"
          python -m pytest tests/test_endpoints_api.py tests/test_health.py tests/test_exception_handling.py -v --tb=short

          # Batch 7: Scheduler and tasks
          echo "Batch 7: Background tasks"
          python -m pytest tests/test_scheduler.py tests/test_ping_tasks.py -v --tb=short

          echo "All test batches completed successfully!"

      - name: Check Celery tasks registration
        run: |
          python manage.py shell -c "
          from app.celery import celery_app
          # Force task discovery by importing task modules
          import monitors.tasks
          import api.tasks
          tasks = [t for t in celery_app.tasks.keys() if not t.startswith('celery.')]
          print(f'Registered tasks: {len(tasks)}')
          for task in sorted(tasks):
              print(f'  - {task}')
          assert len(tasks) >= 3, f'Expected at least 3 tasks, got {len(tasks)}'
          "
