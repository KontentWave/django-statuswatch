services:
  db:
    image: postgres:16
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: devpass
      POSTGRES_DB: dj01
    ports: ["5432:5432"]
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d dj01"]
      interval: 5s
      timeout: 5s
      retries: 5
  redis:
    image: redis:7
    ports: ["6379:6379"]
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5
  web:
    image: ghcr.io/kontentwave/statuswatch-web:edge
    # Override Dockerfile CMD: use Django dev server instead of Gunicorn
    command: python manage.py runserver 0.0.0.0:8000
    ports: ["8003:8000"]
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    pull_policy: always

    # Keep your local defaults in backend/.env (localhost etc.)
    # and override container-specific values here:
    env_file: backend/.env
    environment:
      DJANGO_ENV: development
      DATABASE_URL: postgresql://postgres:devpass@db:5432/dj01
      # >>> IMPORTANT: use the redis *service name* in Compose
      REDIS_URL: redis://redis:6379/0
      CELERY_BROKER_URL: redis://redis:6379/0
      CELERY_RESULT_BACKEND: redis://redis:6379/1
      # optional: write logs to file (see logging section)
      LOG_TO_FILE: "1"

    volumes:
      - ./logs:/app/logs

    # Healthcheck: use GET /health/ (present in image)
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "wget -qO- http://localhost:8000/health/ >/dev/null || exit 1",
        ]
      interval: 10s
      timeout: 5s
      retries: 5

  worker:
    image: ghcr.io/kontentwave/statuswatch-web:edge
    command: celery -A app worker -l info
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    pull_policy: always
    env_file: backend/.env
    environment:
      DJANGO_ENV: development
      DATABASE_URL: postgresql://postgres:devpass@db:5432/dj01
      REDIS_URL: redis://redis:6379/0
      CELERY_BROKER_URL: redis://redis:6379/0
      CELERY_RESULT_BACKEND: redis://redis:6379/1
      LOG_TO_FILE: "1"
    volumes:
      - ./logs:/app/logs

  beat:
    image: ghcr.io/kontentwave/statuswatch-web:edge
    command: celery -A app beat -l info --scheduler django_celery_beat.schedulers:DatabaseScheduler
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    pull_policy: always
    env_file: backend/.env
    environment:
      DJANGO_ENV: development
      DATABASE_URL: postgresql://postgres:devpass@db:5432/dj01
      REDIS_URL: redis://redis:6379/0
      CELERY_BROKER_URL: redis://redis:6379/0
      CELERY_RESULT_BACKEND: redis://redis:6379/1
      LOG_TO_FILE: "1"
    volumes:
      - ./logs:/app/logs
